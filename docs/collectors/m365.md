# Microsoft 365 Collector

The M365 collector (`m365_collect.py`) gathers resource inventory from Microsoft 365 including SharePoint, OneDrive, Exchange, Teams, and optionally Entra ID (Azure AD).

## Basic Usage

```bash
# Set credentials
export MS365_TENANT_ID="your-tenant-id"
export MS365_CLIENT_ID="your-client-id"
export MS365_CLIENT_SECRET="your-client-secret"

# Collect all M365 resources
python3 m365_collect.py

# Include Entra ID users and groups
python3 m365_collect.py --include-entra

# Custom output directory
python3 m365_collect.py -o ./my_output/
```

## Command Line Options

| Option | Description |
|--------|-------------|
| `--tenant-id ID` | Azure AD tenant ID (or use env var) |
| `--client-id ID` | App registration client ID (or use env var) |
| `--client-secret SECRET` | App registration secret (or use env var) |
| `--include-entra` | Include Entra ID users and groups |
| `--skip-sharepoint` | Skip SharePoint sites |
| `--skip-onedrive` | Skip OneDrive accounts |
| `--skip-exchange` | Skip Exchange mailboxes |
| `--skip-teams` | Skip Microsoft Teams |
| `-o, --output PATH` | Output directory |
| `--log-level LEVEL` | Logging level (default: INFO) |

## App Registration Setup

The M365 collector requires an Azure AD App Registration with Microsoft Graph API permissions.

### Step 1: Create App Registration

1. Go to **Azure Portal** → **Azure Active Directory** → **App registrations**
2. Click **New registration**
3. Configure:
   - Name: `CCA-M365-Collector`
   - Supported account types: **Accounts in this organizational directory only**
   - Redirect URI: Leave blank
4. Click **Register**

### Step 2: Note the IDs

From the app registration **Overview** page, copy:
- **Application (client) ID** → `MS365_CLIENT_ID`
- **Directory (tenant) ID** → `MS365_TENANT_ID`

### Step 3: Add API Permissions

1. Go to **API permissions** → **Add a permission**
2. Select **Microsoft Graph** → **Application permissions**
3. Add these permissions:

| Permission | Purpose |
|------------|---------|
| `Sites.Read.All` | Read SharePoint sites |
| `Files.Read.All` | Read OneDrive files/storage |
| `User.Read.All` | Read user profiles & mailboxes |
| `Mail.Read` | Read mailbox metadata |
| `Team.ReadBasic.All` | Read Teams information |
| `Group.Read.All` | Read group membership |
| `Directory.Read.All` | Read Entra ID (optional, for --include-entra) |

4. Click **Grant admin consent for [Your Organization]**
   - Requires Global Administrator or Privileged Role Administrator

### Step 4: Create Client Secret

1. Go to **Certificates & secrets** → **New client secret**
2. Description: `CCA Collector`
3. Expiration: Choose based on your security policy
4. Click **Add**
5. **Copy the secret value immediately** (shown only once) → `MS365_CLIENT_SECRET`

### Step 5: Configure Environment

```bash
export MS365_TENANT_ID="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
export MS365_CLIENT_ID="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
export MS365_CLIENT_SECRET="your-secret-value"
```

Or pass via command line:
```bash
python3 m365_collect.py \
    --tenant-id xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx \
    --client-id xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx \
    --client-secret your-secret-value
```

## Collected Resources

| Resource Type | Service Family | Description |
|---------------|----------------|-------------|
| `m365:sharepoint:site` | SharePoint | Team sites, communication sites |
| `m365:onedrive:drive` | OneDrive | User OneDrive storage |
| `m365:exchange:mailbox` | Exchange | User mailboxes |
| `m365:teams:team` | Teams | Microsoft Teams |
| `m365:entra:user` | EntraID | Directory users (optional) |
| `m365:entra:group` | EntraID | Security and M365 groups (optional) |

## Example Output

**Summary JSON:**
```json
{
    "run_id": "20260211-143052-abc123",
    "timestamp": "2026-02-11T14:30:52.123456Z",
    "provider": "m365",
    "tenant_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "total_resources": 500,
    "total_capacity_gb": 2500.0,
    "summaries": [
        {
            "provider": "m365",
            "service_family": "SharePoint",
            "resource_type": "m365:sharepoint:site",
            "resource_count": 50,
            "total_gb": 1200
        },
        {
            "provider": "m365",
            "service_family": "OneDrive",
            "resource_type": "m365:onedrive:drive",
            "resource_count": 200,
            "total_gb": 800
        }
    ]
}
```

## Troubleshooting

### "Insufficient privileges" Error

- Ensure admin consent is granted for all permissions
- Go to App registration → API permissions → verify green checkmarks

### "Invalid client secret" Error

- Client secrets expire - check the expiration date
- Create a new secret if expired

### Partial Data Collection

Test individual services:
```bash
# Test SharePoint only
python3 m365_collect.py --skip-onedrive --skip-exchange --skip-teams

# Test OneDrive only
python3 m365_collect.py --skip-sharepoint --skip-exchange --skip-teams
```

### Rate Limiting

Microsoft Graph has throttling limits. The collector handles basic retry logic, but very large tenants may experience delays.

## Dependencies

```bash
pip install msgraph-sdk azure-identity
```

## Required Permissions Summary

| Feature | Required Permissions |
|---------|---------------------|
| SharePoint Sites | `Sites.Read.All` |
| OneDrive | `Files.Read.All`, `User.Read.All` |
| Exchange Mailboxes | `User.Read.All`, `Mail.Read` |
| Microsoft Teams | `Team.ReadBasic.All`, `Group.Read.All` |
| Entra ID (optional) | `Directory.Read.All`, `User.Read.All`, `Group.Read.All` |

See [M365 Permissions](../PERMISSIONS.md#microsoft-365-permissions) for complete details.
